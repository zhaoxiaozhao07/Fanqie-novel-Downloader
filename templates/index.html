<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>番茄小说下载器</title>
    <link rel="stylesheet" href="/static/css/style.css?v=20251214">
    <link rel="stylesheet" href="/static/css/modal.css?v=20251214">
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- 顶部栏 -->
        <header class="dashboard-header">
            <div class="brand">
                <img src="https://th.bing.com/th/id/ODF.ImujSAzXjUkVqHU809ZzQQ?w=32&h=32&qlt=90&pcl=fffffc&o=6&cb=ucfimg1&pid=1.2&ucfimg=1" class="app-logo-icon" alt="">
                <h1 class="app-title" data-i18n="app_title">番茄小说下载器</h1>
            </div>
            <div class="header-actions">
                <div class="header-api-source">
                    <div class="api-select-wrapper">
                        <select id="apiSourceSelect" class="form-input form-input-sm" title="下载接口">
                            <option value="">测速中...</option>
                        </select>
                        <iconify-icon class="api-select-loading" icon="line-md:loading-twotone-loop"></iconify-icon>
                    </div>
                </div>
                <button class="btn btn-sm btn-secondary icon-btn" id="langToggle" title="切换语言">
                    <iconify-icon id="langIcon" icon="circle-flags:uk"></iconify-icon>
                </button>
                <a href="https://github.com/POf-L/Fanqie-novel-Downloader" target="_blank" class="btn btn-sm btn-secondary icon-btn" title="GitHub">
                    <iconify-icon icon="line-md:github-loop"></iconify-icon>
                </a>
                <span class="version-tag">v<span id="version">{{ version }}</span></span>
                <div class="window-controls">
                    <button class="win-btn win-minimize" id="winMinimize"></button>
                    <button class="win-btn win-maximize" id="winMaximize"></button>
                    <button class="win-btn win-close" id="winClose"></button>
                </div>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- 左侧主内容区 -->
            <main class="dashboard-main">
                <div class="card content-card">
                    <!-- 导航标签 -->
                    <div class="tab-nav">
                        <button class="tab-btn active" data-tab="search" title="搜索">
                            <iconify-icon icon="line-md:search"></iconify-icon>
                            <span class="tab-label" data-i18n="tab_search">搜索</span>
                        </button>
                        <button class="tab-btn" data-tab="download" title="下载">
                            <iconify-icon icon="line-md:download-loop"></iconify-icon>
                            <span class="tab-label" data-i18n="tab_download">下载</span>
                        </button>
                        <button class="tab-btn" data-tab="queue" title="队列">
                            <iconify-icon icon="line-md:list-3"></iconify-icon>
                            <span class="tab-label" data-i18n="tab_queue">队列</span>
                        </button>
                    </div>

                    <!-- 内容区域 -->
                    <div class="tab-content">
                        <!-- 搜索面板 -->
                        <div class="tab-pane active" id="tab-search">
                            <div class="search-bar-container">
                                <div class="input-group">
                                    <input type="text" id="searchKeyword" class="form-input" placeholder="搜索书名或作者..." data-i18n="search_placeholder">
                                    <button class="btn btn-primary icon-btn" id="searchBtn" title="搜索">
                                        <iconify-icon icon="line-md:search"></iconify-icon>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="searchResults" class="search-results-area">
                                <div class="search-header" id="searchHeader" style="display: none;">
                                    <span class="search-count" id="searchResultCount">0</span>
                                    <button class="btn btn-sm btn-text icon-btn" id="clearSearchBtn" title="清除">
                                        <iconify-icon icon="line-md:close"></iconify-icon>
                                    </button>
                                </div>
                                <div id="searchResultList" class="search-grid">
                                    <div id="loadMoreContainer" class="load-more-container" style="display: none;">
                                        <button class="btn btn-sm btn-secondary" id="loadMoreBtn">
                                            <iconify-icon icon="line-md:arrow-down"></iconify-icon>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 下载面板 -->
                        <div class="tab-pane scrollable" id="tab-download">
                            <div class="download-form-container">
                                <div class="form-group">
                                    <div class="input-group">
                                        <input type="text" id="bookId" class="form-input" placeholder="书籍ID或链接" data-i18n="placeholder_book_id">
                                        <button class="btn btn-primary" id="downloadBtn" data-i18n="btn_add_to_queue">
                                            <iconify-icon icon="line-md:plus"></iconify-icon>
                                        </button>
                                        <button class="btn btn-danger" id="cancelBtn" style="display: none;">
                                            <iconify-icon icon="line-md:close"></iconify-icon>
                                        </button>
                                    </div>
                                </div>
                                <button class="btn btn-text btn-sm" id="clearBtn">
                                    <iconify-icon icon="line-md:backup-restore"></iconify-icon>
                                    <span data-i18n="btn_reset">重置</span>
                                </button>
                            </div>
                            
                            <!-- 内嵌书籍确认区域 -->
                            <div class="inline-confirm-container" id="inlineConfirmContainer" style="display: none;">
                                <div class="inline-confirm-content">
                                    <div class="book-info">
                                        <img id="inlineCover" class="book-cover" alt="封面" style="display:none;" />
                                        <div class="book-details">
                                            <h3 class="book-title" id="inlineBookTitle"></h3>
                                            <p class="book-author" id="inlineBookAuthor"></p>
                                            <p class="book-abstract collapsed" id="inlineBookAbstract"></p>
                                            <p class="book-chapters" id="inlineBookChapters"></p>
                                        </div>
                                    </div>

                                    <div class="chapter-selection">
                                        <h3 data-i18n="title_chapter_selection">章节选择</h3>

                                        <div class="chapter-range">
                                            <label>
                                                <input type="radio" name="inlineChapterMode" value="all" checked>
                                                <span data-i18n="radio_all_chapters">全部章节</span>
                                            </label>
                                            <label>
                                                <input type="radio" name="inlineChapterMode" value="range">
                                                <span data-i18n="radio_range_chapters">范围选择</span>
                                            </label>
                                            <label>
                                                <input type="radio" name="inlineChapterMode" value="quick">
                                                <span data-i18n="radio_quick_range">快速范围</span>
                                            </label>
                                            <label>
                                                <input type="radio" name="inlineChapterMode" value="manual">
                                                <span data-i18n="radio_manual_chapters">手动选择</span>
                                            </label>
                                        </div>

                                        <div class="chapter-loading-hint" id="inlineChapterLoadingHint" style="display:none;">
                                            <iconify-icon icon="line-md:loading-twotone-loop" class="spin"></iconify-icon>
                                            <span id="inlineChapterLoadingText"></span>
                                        </div>

                                        <div class="chapter-inputs" id="inlineChapterInputs" style="display:none;">
                                            <div class="input-row">
                                                <label data-i18n="label_start_chapter">起始章节</label>
                                                <select id="inlineStartChapter" class="chapter-select" disabled></select>
                                            </div>
                                            <div class="input-row">
                                                <label data-i18n="label_end_chapter">结束章节</label>
                                                <select id="inlineEndChapter" class="chapter-select" disabled></select>
                                            </div>
                                        </div>

                                        <div class="chapter-quick-range" id="inlineChapterQuickRange" style="display:none;">
                                            <div class="input-row" style="margin-bottom: 8px;">
                                                <label data-i18n="label_quick_range">章节范围</label>
                                                <input type="text" id="inlineQuickRangeInput" class="form-input"
                                                       placeholder="例如: 1-100, 150, 200-300"
                                                       data-i18n-placeholder="placeholder_quick_range"
                                                       style="width: 100%; font-family: monospace;">
                                            </div>
                                            <div class="quick-range-hint" style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;" data-i18n="hint_quick_range">
                                                支持格式: 单个数字(5)、范围(1-100)、多个范围(1-10, 50-100)
                                            </div>
                                            <div id="inlineQuickRangeResult" style="font-size: 12px; min-height: 20px;"></div>
                                            <button class="btn btn-sm btn-secondary" type="button" id="inlineApplyQuickRangeBtn" style="margin-top: 8px;" data-i18n="btn_apply_range">应用范围</button>
                                        </div>

                                        <div class="chapter-manual-container" id="inlineChapterManualContainer" style="display:none;">
                                            <div class="chapter-actions">
                                                <button class="btn btn-sm btn-secondary" type="button" id="inlineSelectAllBtn" data-i18n="btn_select_all">全选</button>
                                                <button class="btn btn-sm btn-secondary" type="button" id="inlineSelectNoneBtn" data-i18n="btn_select_none">全不选</button>
                                                <button class="btn btn-sm btn-secondary" type="button" id="inlineSelectInvertBtn" data-i18n="btn_invert_selection">反选</button>
                                                <span id="inlineSelectedCount" style="margin-left: auto; font-size: 13px; color: var(--text-secondary);">0</span>
                                            </div>
                                            <div class="chapter-list" id="inlineChapterList"></div>
                                        </div>
                                    </div>

                                    <div class="inline-confirm-footer">
                                        <button class="btn btn-secondary" type="button" id="inlineCancelBtn" data-i18n="btn_cancel">取消</button>
                                        <button class="btn btn-primary" type="button" id="inlineConfirmAddQueueBtn" data-i18n="btn_confirm_add_to_queue">确认添加</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 待下载队列 -->
                        <div class="tab-pane" id="tab-queue">
                            <div class="queue-container">
                                <!-- 下载设置 -->
                                <div class="queue-toolbar">
                                    <div class="queue-path-group">
                                        <input type="text" id="savePath" class="form-input path-input" readonly title="保存路径">
                                        <button class="btn btn-secondary icon-btn" id="browseBtn" title="浏览">
                                            <iconify-icon icon="line-md:folder-plus-twotone"></iconify-icon>
                                        </button>
                                    </div>
                                    <div class="format-selector">
                                        <label class="format-option-card">
                                            <input type="checkbox" name="format" value="txt" id="formatTxt" checked>
                                            <span class="format-name">TXT</span>
                                        </label>
                                        <label class="format-option-card">
                                            <input type="checkbox" name="format" value="epub" id="formatEpub">
                                            <span class="format-name">EPUB</span>
                                        </label>
                                    </div>
                                    <div class="queue-header">
                                        <div class="queue-summary" id="queueSummary">0</div>
                                        <div class="queue-actions">
                                            <button class="btn btn-secondary icon-btn" id="loadFromFileBtn" title="从文件加载书籍列表">
                                                <iconify-icon icon="line-md:document-add"></iconify-icon>
                                            </button>
                                            <input type="file" id="bookListFileInput" accept=".txt" style="display: none;">
                                            <button class="btn btn-primary" id="startQueueBtn" title="开始下载">
                                                <iconify-icon icon="line-md:play"></iconify-icon>
                                            </button>
                                            <button class="btn btn-secondary" id="clearQueueBtn" title="清空">
                                                <iconify-icon icon="line-md:remove"></iconify-icon>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 队列控制按钮 -->
                                <div class="queue-controls" id="queueControls" style="display: none;">
                                    <button class="btn btn-sm btn-warning" id="skipCurrentBtn" title="跳过当前任务">
                                        <iconify-icon icon="line-md:arrow-right"></iconify-icon>
                                        <span data-i18n="btn_skip_current">跳过当前</span>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" id="forceSaveBtn" title="强制保存已下载内容">
                                        <iconify-icon icon="line-md:download-outline"></iconify-icon>
                                        <span data-i18n="btn_force_save">强制保存</span>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" id="retryAllBtn" title="重试所有失败任务" style="display: none;">
                                        <iconify-icon icon="line-md:backup-restore"></iconify-icon>
                                        <span data-i18n="btn_retry_all">重试全部</span>
                                    </button>
                                </div>

                                <div class="queue-list" id="queueList">
                                    <div class="empty-state">
                                        <iconify-icon icon="line-md:coffee-half-empty-twotone-loop" class="empty-icon"></iconify-icon>
                                        <div class="empty-state-text" data-i18n="queue_empty">空</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- 右侧侧边栏 -->
            <aside class="dashboard-sidebar">
                <!-- 状态卡片 -->
                <div class="card status-card">
                    <div class="card-header">
                        <h3>
                            <iconify-icon icon="line-md:downloading-loop"></iconify-icon>
                            <span data-i18n="card_current_task">任务</span>
                        </h3>
                        <span class="status-badge" id="statusText">
                            <iconify-icon icon="line-md:confirm-circle"></iconify-icon>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="book-preview">
                            <div class="book-name" id="bookName" data-i18n="book_no_task">-</div>
                        </div>
                        <div class="progress-section">
                            <div class="progress-info">
                                <iconify-icon icon="line-md:loading-twotone-loop"></iconify-icon>
                                <span class="progress-percent" id="progressPercent">0%</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-bar" id="progressFill" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 日志卡片 -->
                <div class="card log-card">
                    <div class="card-header">
                        <h3>
                            <iconify-icon icon="line-md:text-box"></iconify-icon>
                            <span data-i18n="card_log">日志</span>
                        </h3>
                    </div>
                    <div class="log-container" id="logContainer">
                        <div id="logContent">
                            <div class="log-entry" data-i18n="log_system_started">...</div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- 隐藏元素 -->
    <div id="tab-progress" style="display: none;"></div>
    <span id="progressBadge" style="display: none;"></span>

    <!-- 章节选择弹窗 -->
    <div class="modal" id="chapterModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <iconify-icon icon="line-md:list-3"></iconify-icon>
                    <span data-i18n="modal_chapter_title">章节</span>
                </h3>
                <button class="modal-close" id="chapterModalClose">
                    <iconify-icon icon="line-md:close"></iconify-icon>
                </button>
            </div>
            <div class="modal-body">
                <div class="chapter-actions">
                    <button class="btn btn-sm btn-secondary" id="selectAllBtn" title="全选">
                        <iconify-icon icon="line-md:confirm-circle"></iconify-icon>
                    </button>
                    <button class="btn btn-sm btn-secondary" id="selectNoneBtn" title="全不选">
                        <iconify-icon icon="line-md:circle"></iconify-icon>
                    </button>
                    <button class="btn btn-sm btn-secondary" id="selectInvertBtn" title="反选">
                        <iconify-icon icon="line-md:switch"></iconify-icon>
                    </button>
                    <span id="selectedCount" class="selected-count">0</span>
                </div>
                <div class="chapter-list" id="chapterList">
                    <div class="empty-state">
                        <div class="empty-state-text">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelChaptersBtn">
                    <iconify-icon icon="line-md:close"></iconify-icon>
                </button>
                <button class="btn btn-primary" id="confirmChaptersBtn">
                    <iconify-icon icon="line-md:confirm"></iconify-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- 更新弹窗 -->
    <div class="modal" id="updateModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <iconify-icon icon="line-md:upload-loop"></iconify-icon>
                    <span data-i18n="modal_update_title">更新</span>
                </h3>
                <button class="modal-close" id="updateModalClose">
                    <iconify-icon icon="line-md:close"></iconify-icon>
                </button>
            </div>
            <div class="modal-body">
                <div class="update-info">
                    <p><span id="currentVersion"></span> → <span id="latestVersion"></span></p>
                    <div class="update-description" id="updateDescription"></div>
                    <div id="versionSelector" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeUpdateBtn">
                    <iconify-icon icon="line-md:close"></iconify-icon>
                </button>
                <button class="btn btn-primary" id="downloadUpdateBtn">
                    <iconify-icon icon="line-md:download-loop"></iconify-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- 断点续传确认对话框 -->
    <div class="modal" id="resumeModal" style="display: none;">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3>
                    <iconify-icon icon="line-md:backup-restore"></iconify-icon>
                    <span data-i18n="modal_resume_title">发现未完成的下载</span>
                </h3>
                <button class="modal-close" id="resumeModalClose">
                    <iconify-icon icon="line-md:close"></iconify-icon>
                </button>
            </div>
            <div class="modal-body">
                <p id="resumeMessage">检测到该书籍有未完成的下载，已下载 <span id="resumeChapterCount">0</span> 个章节。</p>
                <p data-i18n="resume_question">是否继续上次的下载？</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="resumeRestartBtn">
                    <iconify-icon icon="line-md:backup-restore"></iconify-icon>
                    <span data-i18n="btn_restart_download">重新下载</span>
                </button>
                <button class="btn btn-primary" id="resumeContinueBtn">
                    <iconify-icon icon="line-md:play"></iconify-icon>
                    <span data-i18n="btn_continue_download">继续下载</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 队列完成摘要对话框 -->
    <div class="modal" id="queueSummaryModal" style="display: none;">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3>
                    <iconify-icon icon="line-md:confirm-circle"></iconify-icon>
                    <span data-i18n="modal_queue_complete_title">队列下载完成</span>
                </h3>
                <button class="modal-close" id="queueSummaryModalClose">
                    <iconify-icon icon="line-md:close"></iconify-icon>
                </button>
            </div>
            <div class="modal-body">
                <div class="queue-summary-stats">
                    <div class="stat-item stat-success">
                        <iconify-icon icon="line-md:confirm-circle"></iconify-icon>
                        <span id="summaryCompleted">0</span>
                        <span data-i18n="summary_completed">成功</span>
                    </div>
                    <div class="stat-item stat-failed">
                        <iconify-icon icon="line-md:close-circle"></iconify-icon>
                        <span id="summaryFailed">0</span>
                        <span data-i18n="summary_failed">失败</span>
                    </div>
                    <div class="stat-item stat-skipped">
                        <iconify-icon icon="line-md:arrow-right-circle"></iconify-icon>
                        <span id="summarySkipped">0</span>
                        <span data-i18n="summary_skipped">跳过</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="summaryCloseBtn">
                    <iconify-icon icon="line-md:close"></iconify-icon>
                    <span data-i18n="btn_close">关闭</span>
                </button>
                <button class="btn btn-primary" id="summaryRetryBtn" style="display: none;">
                    <iconify-icon icon="line-md:backup-restore"></iconify-icon>
                    <span data-i18n="btn_retry_failed">重试失败</span>
                </button>
            </div>
        </div>
    </div>

    <script src="/static/js/i18n.js?v=20251214"></script>
    <script src="/static/js/app.js?v=20251214"></script>
</body>
</html>
